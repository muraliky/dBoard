# Copilot Playwright Refactor — ID/Class-safe Minimal Instructions

## Goals (for Copilot to follow)
- Replace attribute-based selectors (`[data-*]`, `data-test-id`, etc.) with Playwright semantic locators where possible: `getByRole`, `getByLabel`, `getByPlaceholder`, `getByText`.
- **Do NOT convert CSS ID or class selectors (`#id`, `.class`, `[id="..."]`, `[class="..."]`) into `getByLabel`** unless there is explicit evidence of an associated label/aria-label in the recorded file (see Evidence rules below).
- Convert attribute selectors used by `page.locator(...)`, `locator(...)`, `page.fill(...)`, `page.click(...)`, and chained locator usages into semantic locators or `chooseLocator` fallbacks.
- Extract Page Objects into `/pages/<PageName>.ts` with `constructor(page: Page)` and action methods (e.g., `goto()`, `login()`).
- Extract UI verification logic from recorded `expect(...)` calls into Page Object assertion/verification methods (or grouped `verifyManyChecks`) and move locators from expect-classes into Page Objects.
- Do not add hard sleeps (`page.waitForTimeout`, `setTimeout`, etc.). Rely on Playwright auto-waiting and `expect(...).toHave*` assertions.

---

## Files to generate
```
/utilities/locatorHelper.ts
/pages/<PageName>.ts
/tests/<refactored>.spec.ts
```

---

## chooseLocator helper (must be generated exactly)
```ts
// /utilities/locatorHelper.ts
import type { Page, Locator } from '@playwright/test';

export function chooseLocator(page: Page, hints: {
  role?: { role: string, name?: string | RegExp },
  label?: string,
  placeholder?: string,
  text?: string | RegExp,
  id?: string,
  css?: string,
}, fallbackSelector: string): Locator {
  // Try role first
  if (hints.role) {
    try {
      return page.getByRole(hints.role.role as any, hints.role.name ? { name: hints.role.name as any } : undefined);
    } catch {}
  }
  // Try label / placeholder / text (guarded)
  if (hints.label) {
    try { return page.getByLabel(hints.label); } catch {}
  }
  if (hints.placeholder) {
    try { return page.getByPlaceholder(hints.placeholder); } catch {}
  }
  if (hints.text) {
    try { return page.getByText(hints.text as any); } catch {}
  }
  // Last resort: use the original selector (id/class/css)
  return page.locator(fallbackSelector);
}
```

---

## ID / Class safety rules (must-follow)
- **Strict rule:** If the original recorded selector **is a CSS id/class selector** (starts with `#` or `.`), or is an attribute `id`/`class` selector (e.g., `#identifierInput`, `.workitem`, `[id="x"]`), **do not** convert it directly to `page.getByLabel(...)`.
- Instead, **wrap it** with `chooseLocator(...)` and set `id` or `css` in the `hints` object so the POM will prefer semantic locators only if they truly exist at runtime; otherwise it will reliably fall back to the original CSS selector.

**Concrete rule for Copilot conversions:**
1. If selector matches `^#[-_A-Za-z0-9]+` or `^\.[-_A-Za-z0-9]+` or contains `[id=` or `[class=`, then transform like:
   ```ts
   // recorded
   page.locator('#identifierInput').fill('12345');

   // converted (POM constructor)
   this.identifier = chooseLocator(page, { label: 'Identifier', placeholder: 'Identifier', id: 'identifierInput', css: '#identifierInput' }, '#identifierInput');

   // usage
   await this.identifier.fill('12345');
   ```
2. Do not replace such selectors with `page.getByLabel('Identifier')` unless **evidence** exists (see Evidence rules).
3. Treat data-* attribute selectors (e.g., `[data-test-id="x"]`) more aggressively: try semantic locators first, but still wrap in `chooseLocator` fallback if evidence is missing.

---

## Evidence rules for using getByLabel / semantic locators
Only use `getByLabel` / semantic locators for an element if at least one of the following is present in the recorded context (recording file or adjacent code snippets visible to Copilot):
- A direct `getByLabel('...')` call already exists in the recorded file for that element.
- A snippet of HTML in the recording shows a `<label for="the-id">` associated with the element (explicit `for` + `id` pairing).
- The recording contains `aria-label="..."` or `aria-labelledby="..."` being set or referenced for that element.
- The test code already uses a semantic locator for closely related elements (strong heuristic) — only then Copilot may attempt a semantic locator, otherwise it must fallback to original selector.

If none of the evidence items appear, **do not assume** a label exists — use `chooseLocator(..., fallbackSelector)` instead.

---

## Expect-class locator handling (must-follow)
- If an expect-class contains locator declarations, Copilot must move those locators into the appropriate POM constructor as `readonly` Locator members using `chooseLocator` (including `css`/`id` hints for CSS selectors).
- Convert expect-class methods into POM assertion helpers (or thin wrappers that call POM assertion helpers). Update tests to call POM methods or the grouped `verifyManyChecks` helper.
- If expect-class locators span multiple pages, split the locator declarations across relevant POMs and update conversions accordingly.

---

## Examples (Before -> After)
**Before (recorded with id selector):**
```ts
await page.locator('#identifierInput').fill('12345');
await page.locator('.workitem').click();
```

**After (pages/SomePage.ts constructor):**
```ts
this.identifier = chooseLocator(page, { label: 'Identifier', placeholder: 'Identifier', id: 'identifierInput', css: '#identifierInput' }, '#identifierInput');
this.workitem = chooseLocator(page, { id: 'workitem', css: '.workitem' }, '.workitem');
```

**Usage:**
```ts
await this.identifier.fill('12345');
await this.workitem.click();
```

**Do NOT do this** (wrong — avoid unless evidence exists):
```ts
this.identifier = page.getByLabel('Identifier');
```

---

## Final prompt to send to Copilot (copy exactly)
```
Refactor the recorded test below according to the rules in the instructions above.
Important: do NOT convert CSS id/class selectors (e.g., '#id', '.class', '[id=\"...\"]') to getByLabel unless the recording contains explicit evidence (label for=id, aria-label, or existing semantic locators). For id/class selectors always wrap with chooseLocator(..., fallbackSelector) and include id/css in hints.
Convert attribute selectors to semantic locators or chooseLocator fallbacks.
Extract expect(...) logic into POM assertion helpers and move locators from expect-classes into Page Objects.
Create and save files directly in the repo: /utilities/locatorHelper.ts, /pages/<PageName>.ts, /tests/<refactored>.spec.ts
Use TypeScript and @playwright/test. Do not introduce fixed waits.
```

---

End of file.
