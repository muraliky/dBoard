# Copilot Playwright Refactor — Minimal Instructions (Updated with Assertions)

## Goals (for Copilot to follow)
- Replace attribute-based selectors (e.g. `[data-id="..."]`, `[data-test-id="..."]`, `[data-testid="..."]`, `[data-qa="..."]`, `[data-automation-id="..."]`) with Playwright semantic locators where possible: `getByRole`, `getByLabel`, `getByPlaceholder`, `getByText`.
- Detect and convert **all** occurrences of attribute selectors used via `page.locator(...)`, `locator(...)`, `page.fill(...)`, `page.click(...)`, and chained locator usages (e.g., `page.locator(...).fill()` / `page.locator(...).click()`).
- If no semantic locator can be inferred, use `chooseLocator(page, {}, '...')` as a safe fallback that preserves the recorded selector.
- Extract Page Objects into `/pages/<PageName>.ts` with a constructor `constructor(page: Page)` and small action methods (e.g., `goto()`, `login()`).
- Extract UI verification logic from recorded `expect(...)` calls into Page Object assertion/verification methods (e.g. `async expectWelcomeToContain(expected: string)`, `async isErrorVisible(): Promise<boolean>`, or `async getWelcomeText(): Promise<string>`). Tests should call these POM methods rather than duplicating locator logic inline.
- Do not add fixed waits (`page.waitForTimeout`, hard sleeps). Rely on Playwright auto-waiting.

---

## Files to generate
```
/utilities/locatorHelper.ts
/pages/<PageName>.ts
/tests/<refactored>.spec.ts
```

---

## chooseLocator helper (must be generated exactly)
```ts
// /utilities/locatorHelper.ts
import type { Page, Locator } from '@playwright/test';

export function chooseLocator(page: Page, hints: {
  role?: { role: string, name?: string | RegExp },
  label?: string,
  placeholder?: string,
  text?: string | RegExp,
}, fallbackSelector: string): Locator {
  if (hints.role) {
    try {
      return page.getByRole(hints.role.role as any, hints.role.name ? { name: hints.role.name as any } : undefined);
    } catch {}
  }
  if (hints.label) return page.getByLabel(hints.label);
  if (hints.placeholder) return page.getByPlaceholder(hints.placeholder);
  if (hints.text) return page.getByText(hints.text as any);
  return page.locator(fallbackSelector);
}
```

---

## Locator conversion requirements (explicit)
Copilot must handle and convert **all** of these patterns when they reference attribute selectors (data-*, id, aria-*):

1. `page.locator('<selector>')` where `<selector>` is an attribute selector (single/double quotes or backticks). Example:
   - `page.locator('[data-test-id="login-username"]')`
   - `page.locator("[data-testid='submit']")`
   - ``page.locator(`[data-qa="item-${i}"]`)``
2. `locator('<selector>')` (unprefixed locator variable in the same file/context).
3. Chained usage: `await page.locator('[data-test-id="x"]').fill('value')` or `.click()` or `.textContent()`.
4. `page.fill('<selector>', 'value')` and `page.click('<selector>')` when selector is an attribute selector.
5. Stored locator variable: `const el = page.locator('[data-test-id="x"]'); await el.click();` — Copilot must replace the declaration with `const el = chooseLocator(page, {...}, '[data-test-id="x"]');` or a semantic locator.

**Attribute names to treat as high-priority automation hints:**
- `data-test-id`, `data-testid`, `data-qa`, `data-automation-id`, `data-test`, `data-attr`, `data-id`.

**Quotation styles to support:** single quotes `'...'`, double quotes `"..."`, template literals `` `...` `` (with interpolation). Copilot must handle all of these.

---

## Replacement rules (priority)
When converting a selector, Copilot must try these in order and pick the highest-priority semantic locator that fits:
1. **Role + name**: `page.getByRole('button', { name: /Sign in/i })`
2. **Label**: `page.getByLabel('Email')`
3. **Placeholder**: `page.getByPlaceholder('Search...')`
4. **Visible text**: `page.getByText(/Welcome/i)`
5. **Fallback**: `chooseLocator(page, {}, '[data-test-id="..."]')`

If the attribute selector sits on a button/link, prefer `getByRole` with a `name` regex built from the recorded visible text (if present).

---

## Assertions conversion rules
- When the recorded test contains `expect(...)` calls, Copilot must move the locator + assertion logic into the relevant Page Object.
- Create descriptive assertion/verification methods in the POM (e.g. `async expectWelcomeToContain(expected: string)`).
- Tests should call these POM methods, not directly reference locators.
- For complex multi-element assertions, split into smaller POM methods and orchestrate them in the test.

---

## Examples (Before → After)
**Before (recorded):**
```ts
await page.locator('[data-test-id="username-input"]').fill('alice');
await page.locator("[data-test-id='password-input']").fill('password');
await page.locator(`[data-test-id="submit-${env}"]`).click();
await expect(page.locator('[data-test-id="welcome"]')).toContainText('Welcome, Alice');
```

**After (refactored):**
```ts
// inside pages/LoginPage.ts constructor
this.username = chooseLocator(page, { label: 'Username', placeholder: 'Username' }, '[data-test-id="username-input"]');
this.password = chooseLocator(page, { label: 'Password' }, "[data-test-id='password-input']");
this.submit = chooseLocator(page, { role: { role: 'button', name: /sign in|submit/i } }, `[data-test-id="submit-${env}"]`);
this.welcome = chooseLocator(page, { text: /welcome/i }, '[data-test-id="welcome"]');

async expectWelcomeToContain(expected: string) {
  await expect(this.welcome).toContainText(expected);
}

// usage in test
await loginPage.login('alice', 'password');
await loginPage.expectWelcomeToContain('Welcome, Alice');
```

---

## Final prompt to send to Copilot (copy exactly)
```
Refactor the recorded test below according to the rules in the instructions above.
Convert all attribute selectors and expect(...) calls into semantic locators and Page Object methods (action + assertion helpers).
Create and save these files directly in the repo (do not paste file contents in chat):
- /utilities/locatorHelper.ts
- /pages/<PageName>.ts
- /tests/<refactored>.spec.ts
Use TypeScript and @playwright/test. Do not introduce fixed waits.
```

---

End of updated instructions (Minimal + explicit attribute-locator + assertion handling).
