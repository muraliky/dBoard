# Copilot Playwright Refactor — Minimal Instructions (Grouped + ID-safe)

## Goals (for Copilot to follow)
- Replace attribute-based selectors (e.g. `[data-id="..."]`, `[data-test-id="..."]`, `[data-testid="..."]`, `[data-qa="..."]`, `[data-automation-id="..."]`) with Playwright semantic locators where possible (`getByRole`, `getByLabel`, `getByPlaceholder`, `getByText`).
- Convert attribute selectors used via `page.locator(...)`, `locator(...)`, `page.fill(...)`, `page.click(...)`, and chained locator usages into semantic locators or `chooseLocator` fallbacks.
- Extract Page Objects into `/pages/<PageName>.ts` with `constructor(page: Page)` and action methods (e.g., `goto()`, `login()`).
- Extract UI verification logic from recorded `expect(...)` calls into Page Object assertion helpers and group multiple expect-classes into a single grouped POM method when they target the same page.
- Do not add fixed waits. Rely on Playwright auto-waiting.

---

## Files to generate
```
/utilities/locatorHelper.ts
/pages/<PageName>.ts
/tests/<refactored>.spec.ts
```

---

## chooseLocator helper (must be generated exactly)
```ts
// /utilities/locatorHelper.ts
import type { Page, Locator } from '@playwright/test';

export function chooseLocator(page: Page, hints: {
  role?: { role: string, name?: string | RegExp },
  label?: string,
  placeholder?: string,
  text?: string | RegExp,
  id?: string, // optional hint for id-based fallback
}, fallbackSelector: string): Locator {
  if (hints.role) {
    try {
      return page.getByRole(hints.role.role as any, hints.role.name ? { name: hints.role.name as any } : undefined);
    } catch {}
  }
  if (hints.label) {
    try { return page.getByLabel(hints.label); } catch {}
  }
  if (hints.placeholder) {
    try { return page.getByPlaceholder(hints.placeholder); } catch {}
  }
  if (hints.text) {
    try { return page.getByText(hints.text as any); } catch {}
  }
  // id hint: if present and fallbackSelector is not ideal, still use fallbackSelector
  return page.locator(fallbackSelector);
}
```

---

## Locator conversion guidance (explicit)
- Always prefer semantic locators in this order: `getByRole` → `getByLabel` → `getByPlaceholder` → `getByText`.
- **ID-safety rule (important):** if the recorded selector is an `#id` (e.g., `#identifierInput`) or Copilot cannot confirm a matching label/placeholder/role exists, **do not** convert it into `getByLabel` blindly. Instead create a `chooseLocator(...)` that includes semantic hints **and** uses the `#id` as the `fallbackSelector`:
  ```ts
  this.identifier = chooseLocator(page, { label: 'Identifier', placeholder: 'Identifier', id: 'identifierInput' }, '#identifierInput');
  ```
  This ensures the POM will use semantic locators when they actually exist, but will reliably fall back to the original `#id` when they don't.
- For attribute selectors (`data-*`) follow the same pattern but prefer semantic locators if visible text/labels exist; otherwise use `chooseLocator` fallback.
- Preserve template literals and variable interpolation in fallback selectors (e.g., `` `[data-test-id="submit-${env}"]` ``) when migrating to `chooseLocator`.

---

## Grouped assertion method pattern (when multiple expect-classes target the same page)
Create a single grouped POM method `verifyManyChecks(checks: Check[])` with a compact `Check` type:

```ts
type Check = {
  name: string;                 // logical name of the check (e.g., 'welcome', 'errorBanner')
  locatorHints?: any;           // optional hints for chooseLocator if needed
  expected?: string | RegExp;   // expected text or regex
  present?: boolean;            // whether element should exist/be visible
  contains?: string | RegExp;   // alias for expected; can be used for partial matches
  count?: number;               // expected count of matching elements
  custom?: (page: Page) => Promise<boolean>; // optional ad-hoc check
};
```

Implementation notes:
- Map check `name` values to locators declared in the POM (declare locators in constructor using `chooseLocator` or semantic locators).
- For `id`-based locators include `id` in `locatorHints` to ensure safe fallback.
- Use `await expect(locator).toHaveText(...)`, `toBeVisible()`, or `toHaveCount(...)` inside the POM.
- Support `custom` callbacks for complex checks.

---

## Examples (Before -> After)

**Before (recorded with id selector):**
```ts
await page.locator('#identifierInput').fill('12345');
await page.locator('[data-test-id="welcome"]').textContent();
```

**After (POM constructor):**
```ts
// pages/SomePage.ts constructor (excerpt)
this.identifier = chooseLocator(page, { label: 'Identifier', placeholder: 'Identifier', id: 'identifierInput' }, '#identifierInput');
this.welcome = chooseLocator(page, { text: /welcome/i }, '[data-test-id="welcome"]');
```

**Usage in grouped assertion method:**
```ts
await this.verifyManyChecks([
  { name: 'welcome', expected: 'Welcome, Alice' },
  { name: 'identifier', present: true }
]);
```

---

## Final prompt to send to Copilot
```
Refactor the recorded test below according to the rules in the instructions above.
Convert attribute selectors to semantic locators or chooseLocator fallbacks. For #id selectors do not force conversion to getByLabel; instead wrap them in chooseLocator with the id as fallback.
Extract expect(...) logic into POM assertion helpers. If multiple expect-classes validate the same page, group them into a single POM method verifyManyChecks(checks: Check[]).
Create and save files directly in the repo: /utilities/locatorHelper.ts, /pages/<PageName>.ts, /tests/<refactored>.spec.ts
Use TypeScript and @playwright/test. Do not introduce fixed waits.
```

---

End of file.
