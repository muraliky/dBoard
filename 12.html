// DEBUG CHART DISPLAY ISSUES
// Run these functions to identify why the chart isn't showing data

// STEP 1: Check if chart canvas exists and is accessible
function debug1_CheckCanvas() {
    console.log('\nüîç STEP 1: Checking chart canvas');
    
    const canvas = document.getElementById('testCasesTrendsChart');
    if (!canvas) {
        console.error('‚ùå Canvas element not found!');
        return false;
    }
    
    console.log('‚úÖ Canvas found:', canvas);
    console.log('Canvas dimensions:', { width: canvas.width, height: canvas.height });
    console.log('Canvas style:', { width: canvas.style.width, height: canvas.style.height });
    
    const ctx = canvas.getContext('2d');
    console.log('‚úÖ Canvas context:', ctx);
    
    return true;
}

// STEP 2: Check if Chart.js is loaded and chart instance exists
function debug2_CheckChartInstance() {
    console.log('\nüîç STEP 2: Checking Chart.js and chart instance');
    
    if (typeof Chart === 'undefined') {
        console.error('‚ùå Chart.js not loaded!');
        return false;
    }
    
    console.log('‚úÖ Chart.js loaded, version:', Chart.version);
    
    // Check if chart instance exists
    if (typeof charts === 'undefined') {
        console.error('‚ùå Charts object not defined!');
        return false;
    }
    
    console.log('Charts object:', charts);
    
    if (charts.testCasesTrends) {
        console.log('‚úÖ Trends chart instance exists:', charts.testCasesTrends);
        console.log('Chart data:', charts.testCasesTrends.data);
        console.log('Chart datasets:', charts.testCasesTrends.data.datasets);
        return true;
    } else {
        console.log('‚ùå Trends chart instance not found');
        return false;
    }
}

// STEP 3: Validate chart data structure
function debug3_ValidateChartData() {
    console.log('\nüîç STEP 3: Validating chart data structure');
    
    if (!charts.testCasesTrends) {
        console.error('‚ùå No chart instance to validate');
        return false;
    }
    
    const chartData = charts.testCasesTrends.data;
    
    console.log('Chart labels:', chartData.labels);
    console.log('Number of datasets:', chartData.datasets.length);
    
    chartData.datasets.forEach((dataset, index) => {
        console.log(`\nDataset ${index + 1}:`);
        console.log('  Label:', dataset.label);
        console.log('  Data:', dataset.data);
        console.log('  Data length:', dataset.data.length);
        console.log('  Data sum:', dataset.data.reduce((sum, val) => sum + (val || 0), 0));
        console.log('  Border color:', dataset.borderColor);
        console.log('  Background color:', dataset.backgroundColor);
        
        // Check for issues
        if (dataset.data.length === 0) {
            console.warn('‚ö†Ô∏è  Dataset has no data points');
        }
        
        if (dataset.data.every(val => val === 0 || val === null || val === undefined)) {
            console.warn('‚ö†Ô∏è  All data points are zero/null/undefined');
        }
        
        if (dataset.data.length !== chartData.labels.length) {
            console.warn('‚ö†Ô∏è  Data length doesn\'t match labels length');
        }
    });
    
    return true;
}

// STEP 4: Check chart options and scales
function debug4_CheckChartOptions() {
    console.log('\nüîç STEP 4: Checking chart options and scales');
    
    if (!charts.testCasesTrends) {
        console.error('‚ùå No chart instance to check');
        return false;
    }
    
    const chart = charts.testCasesTrends;
    console.log('Chart options:', chart.options);
    
    // Check scales
    if (chart.options.scales) {
        console.log('X-axis scale:', chart.options.scales.x);
        console.log('Y-axis scale:', chart.options.scales.y);
        
        // Check if y-axis has proper min/max
        if (chart.options.scales.y.beginAtZero === false) {
            console.warn('‚ö†Ô∏è  Y-axis beginAtZero is false');
        }
    }
    
    // Check if chart is visible
    const canvas = chart.canvas;
    const computedStyle = window.getComputedStyle(canvas);
    console.log('Canvas computed style:');
    console.log('  Display:', computedStyle.display);
    console.log('  Visibility:', computedStyle.visibility);
    console.log('  Opacity:', computedStyle.opacity);
    console.log('  Width:', computedStyle.width);
    console.log('  Height:', computedStyle.height);
    
    return true;
}

// STEP 5: Force chart update and check for errors
function debug5_ForceChartUpdate() {
    console.log('\nüîç STEP 5: Force updating chart');
    
    if (!charts.testCasesTrends) {
        console.error('‚ùå No chart instance to update');
        return false;
    }
    
    try {
        console.log('Attempting chart update...');
        charts.testCasesTrends.update('active');
        console.log('‚úÖ Chart update successful');
        
        // Also try forcing a resize
        charts.testCasesTrends.resize();
        console.log('‚úÖ Chart resize successful');
        
        return true;
    } catch (error) {
        console.error('‚ùå Error updating chart:', error);
        return false;
    }
}

// STEP 6: Create a simple test chart to verify Chart.js works
function debug6_CreateTestChart() {
    console.log('\nüîç STEP 6: Creating test chart');
    
    const canvas = document.getElementById('testCasesTrendsChart');
    if (!canvas) {
        console.error('‚ùå Canvas not found');
        return false;
    }
    
    // Destroy existing chart
    if (charts.testCasesTrends) {
        charts.testCasesTrends.destroy();
    }
    
    try {
        // Create simple test chart
        charts.testCasesTrends = new Chart(canvas, {
            type: 'line',
            data: {
                labels: ['January', 'February', 'March'],
                datasets: [{
                    label: 'Test Data',
                    data: [10, 20, 30],
                    borderColor: '#c41e3a',
                    backgroundColor: '#c41e3a20',
                    borderWidth: 3,
                    fill: false
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
        
        console.log('‚úÖ Test chart created successfully');
        return true;
    } catch (error) {
        console.error('‚ùå Error creating test chart:', error);
        return false;
    }
}

// COMPREHENSIVE DEBUG FUNCTION
function debugChartDisplayIssue() {
    console.log('\nüöÄ DEBUGGING CHART DISPLAY ISSUE');
    console.log('=====================================');
    
    const results = {
        canvas: debug1_CheckCanvas(),
        chartInstance: debug2_CheckChartInstance(),
        chartData: false,
        chartOptions: false,
        chartUpdate: false,
        testChart: false
    };
    
    if (results.canvas && results.chartInstance) {
        results.chartData = debug3_ValidateChartData();
        results.chartOptions = debug4_CheckChartOptions();
        results.chartUpdate = debug5_ForceChartUpdate();
    }
    
    // If everything fails, try test chart
    if (!results.chartInstance || !results.chartUpdate) {
        results.testChart = debug6_CreateTestChart();
    }
    
    console.log('\nüìä DEBUG RESULTS:');
    console.log('Canvas exists:', results.canvas ? '‚úÖ' : '‚ùå');
    console.log('Chart instance:', results.chartInstance ? '‚úÖ' : '‚ùå');
    console.log('Chart data valid:', results.chartData ? '‚úÖ' : '‚ùå');
    console.log('Chart options valid:', results.chartOptions ? '‚úÖ' : '‚ùå');
    console.log('Chart update works:', results.chartUpdate ? '‚úÖ' : '‚ùå');
    console.log('Test chart works:', results.testChart ? '‚úÖ' : '‚ùå');
    
    // Provide recommendations
    console.log('\nüí° RECOMMENDATIONS:');
    
    if (!results.canvas) {
        console.log('‚ùå Create canvas element with id="testCasesTrendsChart"');
    }
    
    if (!results.chartInstance) {
        console.log('‚ùå Chart.js not loaded or chart not created properly');
    }
    
    if (!results.chartData) {
        console.log('‚ùå Check your data - all datasets might be empty or have zero values');
    }
    
    if (!results.chartUpdate) {
        console.log('‚ùå Chart update failed - might be a Chart.js configuration issue');
    }
    
    if (results.testChart) {
        console.log('‚úÖ Chart.js works - issue is with your data or configuration');
    }
    
    return results;
}

// FIXED CHART RENDERING FUNCTION WITH DEBUGGING
function renderTestCasesTrendsChartWithDebug(data) {
    console.log('\nüöÄ RENDERING TRENDS CHART WITH DEBUG');
    
    const ctx = document.getElementById('testCasesTrendsChart');
    if (!ctx) {
        console.error('‚ùå Canvas not found');
        return;
    }
    
    // Destroy existing chart
    if (charts && charts.testCasesTrends) {
        console.log('üóëÔ∏è  Destroying existing chart');
        charts.testCasesTrends.destroy();
        charts.testCasesTrends = null;
    }
    
    const sourceData = data || qualityData || [];
    if (sourceData.length === 0) {
        console.error('‚ùå No source data');
        return;
    }
    
    // Get months and entities (assuming you have these functions)
    const monthsToShow = getMonthsForTrendsSimple(filters.month);
    if (monthsToShow.length === 0) {
        console.error('‚ùå No months to show');
        return;
    }
    
    console.log('üìÖ Months to show:', monthsToShow);
    
    // Create test datasets first
    const testDatasets = [{
        label: 'Test Dataset',
        data: [100, 200, 300],
        borderColor: '#c41e3a',
        backgroundColor: '#c41e3a20',
        borderWidth: 3,
        fill: false,
        tension: 0.4
    }];
    
    console.log('üìä Creating chart with test data first...');
    
    try {
        charts.testCasesTrends = new Chart(ctx, {
            type: 'line',
            data: {
                labels: monthsToShow.length >= 3 ? monthsToShow : ['Month 1', 'Month 2', 'Month 3'],
                datasets: testDatasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                        labels: {
                            usePointStyle: true
                        }
                    }
                },
                scales: {
                    x: {
                        grid: { display: true },
                        title: {
                            display: true,
                            text: 'Months'
                        }
                    },
                    y: {
                        beginAtZero: true,
                        grid: { display: true },
                        title: {
                            display: true,
                            text: 'Test Cases'
                        }
                    }
                }
            }
        });
        
        console.log('‚úÖ Test chart created successfully');
        
        // Now update with real data after a short delay
        setTimeout(() => {
            console.log('üîÑ Updating with real data...');
            updateChartWithRealData();
        }, 1000);
        
    } catch (error) {
        console.error('‚ùå Error creating chart:', error);
    }
}

// Function to update chart with real data
function updateChartWithRealData() {
    if (!charts.testCasesTrends) {
        console.error('‚ùå No chart to update');
        return;
    }
    
    console.log('üìä Calculating real datasets...');
    
    // Use your existing dataset calculation logic here
    // const realDatasets = calculateDatasetsFixed(entitiesToCompare, monthsToShow, sourceData, filters);
    
    // For now, create sample real data
    const realDatasets = [
        {
            label: 'Group A',
            data: [150, 180, 220],
            borderColor: '#c41e3a',
            backgroundColor: '#c41e3a20',
            borderWidth: 3,
            fill: false,
            tension: 0.4
        },
        {
            label: 'Group B',
            data: [100, 140, 160],
            borderColor: '#3498db',
            backgroundColor: '#3498db20',
            borderWidth: 3,
            fill: false,
            tension: 0.4
        }
    ];
    
    console.log('üìä Real datasets:', realDatasets);
    
    // Update chart data
    charts.testCasesTrends.data.datasets = realDatasets;
    charts.testCasesTrends.update('active');
    
    console.log('‚úÖ Chart updated with real data');
}

// SIMPLE WORKING CHART FUNCTION
function createSimpleWorkingChart() {
    console.log('\nüöÄ Creating simple working chart');
    
    const ctx = document.getElementById('testCasesTrendsChart');
    if (!ctx) {
        console.error('‚ùå Canvas not found');
        return;
    }
    
    // Destroy existing
    if (charts && charts.testCasesTrends) {
        charts.testCasesTrends.destroy();
    }
    
    // Create simple chart that definitely works
    charts.testCasesTrends = new Chart(ctx, {
        type: 'line',
        data: {
            labels: ['January', 'February', 'March'],
            datasets: [{
                label: 'Test Cases',
                data: [100, 200, 150],
                borderColor: '#c41e3a',
                backgroundColor: '#c41e3a20',
                borderWidth: 2,
                fill: false,
                pointBackgroundColor: '#c41e3a',
                pointBorderColor: '#ffffff',
                pointBorderWidth: 2,
                pointRadius: 5
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: true,
                    position: 'top'
                }
            },
            scales: {
                x: {
                    display: true,
                    title: {
                        display: true,
                        text: 'Months'
                    }
                },
                y: {
                    display: true,
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Number of Test Cases'
                    }
                }
            }
        }
    });
    
    console.log('‚úÖ Simple chart created');
}

// USAGE INSTRUCTIONS
console.log(`
üîç TO DEBUG YOUR CHART DISPLAY ISSUE:

1. Run: debugChartDisplayIssue()
   - This will check everything systematically

2. If that doesn't work, run: createSimpleWorkingChart()
   - This creates a basic working chart to test Chart.js

3. If simple chart works, the issue is in your data/configuration
   Run: renderTestCasesTrendsChartWithDebug(yourData)

4. Check browser console for any JavaScript errors
   - Press F12 and look in Console tab

5. Verify your HTML has: <canvas id="testCasesTrendsChart"></canvas>
`);
